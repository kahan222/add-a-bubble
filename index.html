<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text Bubble Capture</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background: black;
    }

    #camera-view {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }

    .text-carousel {
      position: absolute;
      bottom: 0;
      width: 100vw;
      height: 80px;
      display: flex;
      overflow-x: scroll;
      background: rgba(0,0,0,0.4);
      padding: 10px;
      box-sizing: border-box;
      z-index: 10;
    }

    .text-option {
      background: white;
      color: black;
      font-weight: bold;
      border-radius: 20px;
      padding: 10px 16px;
      margin: 0 8px;
      white-space: nowrap;
      cursor: pointer;
      font-size: 14px;
    }

    #bubble-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 14px 20px;
      border-radius: 20px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      max-width: 80vw;
      text-align: center;
      z-index: 5;
      pointer-events: auto;
      cursor: grab;
      user-select: none;
      text-shadow: 1px 1px 2px black;
      display: none;
    }

    .quote-en, .quote-ko {
      margin: 4px 0;
    }

    #toggle-lang, #capture {
      position: absolute;
      z-index: 10;
      background: white;
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }

    #toggle-lang {
      bottom: 120px;
      right: 100px;
    }

    #capture {
      bottom: 30px;
      right: 20px;
      width: 60px;
      height: 60px;
      font-size: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <video id="camera-view" autoplay playsinline muted></video>

  <div class="text-carousel">
    <div class="text-option" data-id="picasso">Picasso 피카소</div>
    <div class="text-option" data-id="davinci">Da Vinci 다빈치</div>
    <div class="text-option" data-id="paik">Paik 백남준</div>
  </div>

  <div id="bubble-text">
    <div class="quote-en"></div>
    <div class="quote-ko"></div>
  </div>

  <button id="toggle-lang">🇰🇷/🇺🇸</button>
  <button id="capture">📸</button>

  <script>
    const video = document.getElementById('camera-view');
    const bubble = document.getElementById('bubble-text');
    const quoteEn = document.querySelector('.quote-en');
    const quoteKo = document.querySelector('.quote-ko');
    const toggleBtn = document.getElementById('toggle-lang');

    const quotes = {
      picasso: {
        en: "Art is a lie that tells the truth.",
        ko: "예술은 진실을 말해주는 거짓말이다."
      },
      davinci: {
        en: "Simplicity is the ultimate sophistication.",
        ko: "단순함은 최고의 정교함이다."
      },
      paik: {
        en: "TV is the most powerful mirror.",
        ko: "TV는 가장 강력한 거울이다."
      }
    };

    let currentLang = 'en';

    function updateQuote(id) {
      const quote = quotes[id];
      if (!quote) return;
      quoteEn.textContent = quote.en;
      quoteKo.textContent = quote.ko;
      bubble.style.display = 'block';
      bubble.style.left = '50%';
      bubble.style.top = '50%';
      bubble.style.transform = 'translate(-50%, -50%)';
      updateLangVisibility();
    }

    function updateLangVisibility() {
      quoteEn.style.display = (currentLang === 'en') ? 'block' : 'none';
      quoteKo.style.display = (currentLang === 'ko') ? 'block' : 'none';
    }

    document.querySelectorAll('.text-option').forEach(option => {
      option.addEventListener('click', () => {
        const id = option.dataset.id;
        updateQuote(id);
      });
    });

    toggleBtn.addEventListener('click', () => {
      currentLang = (currentLang === 'en') ? 'ko' : 'en';
      updateLangVisibility();
    });

    // 드래그 기능
    let isDragging = false;
    let offsetX, offsetY;

    bubble.addEventListener('mousedown', startDrag);
    bubble.addEventListener('touchstart', startDrag, { passive: false });

    function startDrag(e) {
      isDragging = true;
      const rect = bubble.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;

      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
      document.addEventListener('touchmove', onDrag, { passive: false });
      document.addEventListener('touchend', stopDrag);
    }

    function onDrag(e) {
      if (!isDragging) return;
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      bubble.style.left = `${clientX - offsetX}px`;
      bubble.style.top = `${clientY - offsetY}px`;
      bubble.style.transform = `translate(0, 0)`;
    }

    function stopDrag() {
      isDragging = false;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
      document.removeEventListener('touchmove', onDrag);
      document.removeEventListener('touchend', stopDrag);
    }

    // 카메라 연결
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
      });

    // 고화질 캡처
    document.getElementById('capture').addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      const width = video.videoWidth;
      const height = video.videoHeight;

      if (!width || !height) {
        alert("카메라 준비 중입니다.");
        return;
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      ctx.drawImage(video, 0, 0, width, height);

      const bubbleRect = bubble.getBoundingClientRect();
      const videoRect = video.getBoundingClientRect();
      const scaleX = width / videoRect.width;
      const scaleY = height / videoRect.height;

      const x = (bubbleRect.left - videoRect.left) * scaleX;
      const y = (bubbleRect.top - videoRect.top) * scaleY;

      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillRect(x, y, bubbleRect.width * scaleX, bubbleRect.height * scaleY);

      ctx.fillStyle = "white";
      ctx.font = `${20 * scaleY}px sans-serif`;
      ctx.textAlign = "center";

      const lines = [];
      if (currentLang === 'en') {
        lines.push(quoteEn.textContent);
      } else {
        lines.push(quoteKo.textContent);
      }

      lines.forEach((line, i) => {
        ctx.fillText(line, x + (bubbleRect.width * scaleX) / 2, y + (30 * scaleY) + i * (30 * scaleY));
      });

      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = 'text-bubble-capture.png';
      link.click();
    });
  </script>
</body>
</html>
