<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text Bubble Capture</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      overflow: hidden;
      font-family: sans-serif;
      background: black;
    }
    #camera-view {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    .text-carousel {
      position: absolute;
      bottom: 0;
      width: 100vw;
      height: 80px;
      display: flex;
      overflow-x: auto;
      background: rgba(0,0,0,0.4);
      padding: 6px;
      z-index: 10;
    }
    .text-option {
      background: white;
      color: black;
      border-radius: 12px;
      padding: 4px 10px;
      margin: 0 6px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .text-option.selected {
      background: #f0f0f0;
    }
    .name-en { font-weight: bold; }
    .name-ko { font-size: 12px; color: #555; }

    #bubble-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: transparent;
      padding: 0;
      border-radius: 0;
      color: white;
      font-size: 18px;
      font-weight: bold;
      max-width: 80vw;
      text-align: center;
      z-index: 5;
      pointer-events: auto;
      cursor: grab;
      user-select: none;
      display: none;
      word-break: break-word;
    }

    .quote-en, .quote-ko { margin: 4px 0; }

    #toggle-lang, #capture, #share, #style-toggle, #reset {
      position: absolute;
      z-index: 10;
      background: white;
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }

    #toggle-lang { bottom: 120px; left: 20px; font-weight: bold; }

    #capture {
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 60px;
      font-size: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #style-toggle { bottom: 120px; right: 20px; }

    #share { bottom: 200px; left: 20px; }

    #reset { top: 20px; right: 20px; }

    #share:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .bubble-style-neon-green {
      text-shadow:
        0 0 5px #00ff90,
        0 0 10px #00ff90,
        0 0 20px #00ff90,
        0 0 40px #00ff90;
    }

    .bubble-style-neon-orange {
      text-shadow:
        0 0 5px #ffaa00,
        0 0 10px #ffaa00,
        0 0 20px #ffaa00,
        0 0 40px #ffaa00;
    }

    .bubble-style-neon-blue {
      text-shadow:
        0 0 5px #00ccff,
        0 0 10px #00ccff,
        0 0 20px #00ccff,
        0 0 40px #00ccff;
    }
  </style>
</head>
<body>

    <video id="camera-view" autoplay playsinline muted></video>

  <div class="text-carousel">
    <div class="text-option" data-id="Han1"><div class="name-en">one sentence</div><div class="name-ko">í•œ ë¬¸ì¥</div></div>
    <div class="text-option" data-id="Han2"><div class="name-en">try</div><div class="name-ko">ì‹œë„</div></div>
    <div class="text-option" data-id="Han3"><div class="name-en">life</div><div class="name-ko">ì‚¶</div></div>
    <div class="text-option" data-id="Han4"><div class="name-en">unique</div><div class="name-ko">ìœ ì¼í•¨</div></div>
    <div class="text-option" data-id="Han5"><div class="name-en">uncomfortable</div><div class="name-ko">ë¶ˆí¸í•¨</div></div>
    <div class="text-option" data-id="Han6"><div class="name-en">technology</div><div class="name-ko">ê¸°ìˆ </div></div>
    <div class="text-option" data-id="Han7"><div class="name-en">Perfect</div><div class="name-ko">ì™„ë²½</div></div>
    <div class="text-option" data-id="Han8"><div class="name-en">incomplete</div><div class="name-ko">ë¯¸ì™„ì„±</div></div>
    <div class="text-option" data-id="Han9"><div class="name-en">truth</div><div class="name-ko">ì§„ì‹¤</div></div>
    <div class="text-option" data-id="Han10"><div class="name-en">thief</div><div class="name-ko">ë„ë‘‘</div></div>
  </div>

  <div id="bubble-text">
    <div class="quote-en"></div>
    <div class="quote-ko"></div>
  </div>

  <button id="toggle-lang">KO / EN</button>
  <button id="capture">ğŸ“¸</button>
  <button id="style-toggle">Style</button>
  <button id="reset">â†» Reset</button>
  <button id="save" style="display: none; position: absolute; bottom: 60px; left: 20px;">Save</button>
  <button id="share" style="display: none; position: absolute; bottom: 60px; right: 20px;">Share the Bubble</button>

  <script>
    const video = document.getElementById('camera-view');
    const bubble = document.getElementById('bubble-text');
    const quoteEn = document.querySelector('.quote-en');
    const quoteKo = document.querySelector('.quote-ko');

    const quotes = {
     Han1: {
        en: "If it can be expressed in one sentence, is it really art?",
        ko: "í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„ì´ ê°€ëŠ¥í•˜ë‹¤ë©´, ê·¸ê²Œ ì˜ˆìˆ ì´ ë§ëŠ”ê°€?"
      },
      Han2: {
        en: "If you think you can do it too, maybe you should try.",
        ko: "ë‚˜ë„ í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤ë©´, í•œ ë²ˆ í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì„ë“¯."
      },
      Han3: {
        en: "How many people truly equate art with life?",
        ko: "ì˜ˆìˆ ê³¼ ì‚¶ì„ ë™ì¼ì‹œ í•˜ëŠ” ì‚¬ëŒì´ ëª‡ì´ë‚˜ ë˜ê² ëŠ”ê°€."
      },
      Han4: {
        en: "If uniqueness defines art, that idea is already outdated.",
        ko: "ìœ ì¼í•¨ì´ ì˜ˆìˆ ì˜ íŠ¹ì„±ì´ë€ ë§ì€, ì˜› ë§ì¼ ë¿ì´ë‹¤."
      },
      Han5: {
        en: "Uncomfortable to see, impossible to forget.",
        ko: "ë¶ˆí¸í•´ì„œ ëˆˆì„ í”¼í–ˆì§€ë§Œ, ê³„ì† ìƒê°ë‚˜ë”ë¼."
      },
      Han6: {
        en: "The more technology evolves, the more extraordinary the artist becomes.",
        ko: "ê¸°ìˆ ì´ ë°œì „í• ìˆ˜ë¡ ì˜ˆìˆ ê°€ëŠ” ë” ëŒ€ë‹¨í•´ì§„ë‹¤."
      },
      Han7: {
        en: "Perfect order leaves no room for imagination.",
        ko: "ì™„ë²½í•œ ì§ˆì„œëŠ” ìƒìƒë ¥ì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ”ë‹¤."
      },
      Han8: {
        en: "Without a viewer, it's incomplete.",
        ko: "ë³´ëŠ” ì´ê°€ ì—†ìœ¼ë©´, ë¯¸ì™„ì„±ì´ë‹¤."
      },
      Han9: {
        en: "If all you want is to speak the truth, go to a news studio, not a gallery.",
        ko: "ì§„ì‹¤ë§Œì„ ë§í•˜ë ¤ë©´, ë¯¸ìˆ ê´€ì´ ì•„ë‹ˆë¼ ë°©ì†¡êµ­ìœ¼ë¡œ ê°€ë¼."
      },
      Han10: {
        en: "Some works retrieve forgotten memories like a thief.",
        ko: "ì–´ë–¤ ì‘í’ˆì€ ìŠê³  ìˆì—ˆë˜ ê¸°ì–µì„ ë„ë‘‘ì²˜ëŸ¼ ì°¾ì•„ë‚¸ë‹¤."
      }
    };


    let currentLang = 'en';

    function updateQuote(id, optionEl) {
      const quote = quotes[id];
      if (!quote) return;
      quoteEn.textContent = quote.en;
      quoteKo.textContent = quote.ko;
      bubble.style.display = 'block';
      bubble.style.left = '50%';
      bubble.style.top = '50%';
      bubble.style.transform = 'translate(-50%, -50%)';
      updateLangVisibility();
      document.querySelectorAll('.text-option').forEach(el => el.classList.remove('selected'));
      optionEl.classList.add('selected');
    }

    function updateLangVisibility() {
      quoteEn.style.display = (currentLang === 'en') ? 'block' : 'none';
      quoteKo.style.display = (currentLang === 'ko') ? 'block' : 'none';
    }

    document.querySelectorAll('.text-option').forEach(option => {
      option.addEventListener('click', () => updateQuote(option.dataset.id, option));
    });

    document.getElementById('toggle-lang').addEventListener('click', () => {
      currentLang = (currentLang === 'en') ? 'ko' : 'en';
      updateLangVisibility();
    });

    const neonClasses = [
      'bubble-style-neon-green',
      'bubble-style-neon-orange',
      'bubble-style-neon-blue'
    ];
    let currentNeonIndex = 0;
    bubble.classList.add(neonClasses[0]);

    document.getElementById('style-toggle').addEventListener('click', () => {
      bubble.classList.remove(neonClasses[currentNeonIndex]);
      currentNeonIndex = (currentNeonIndex + 1) % neonClasses.length;
      bubble.classList.add(neonClasses[currentNeonIndex]);
    });

    document.getElementById('reset').addEventListener('click', resetUI);

function showShareCombinedButton() {
  const btn = document.createElement('button');
  btn.id = 'share-combined';
  btn.textContent = 'ğŸ“¤ Save & Share the Bubble';
  btn.style = `
    position: absolute;
    bottom: 200px;
    left: 20px;
    z-index: 10;
    background: white;
    border: none;
    border-radius: 10px;
    padding: 6px 10px;
    font-size: 14px;
    cursor: pointer;
  `;

  btn.onclick = async () => {
    if (!lastCaptureBlob) return;

    // â‘  ë‹¤ìš´ë¡œë“œ
    const url = URL.createObjectURL(lastCaptureBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'bubble.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    // â‘¡ Bubble Storage ì—…ë¡œë“œ
    await uploadCapturedImage(lastCaptureBlob);

    alert('âœ… ì €ì¥ ë° Bubble Storage ê³µìœ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    btn.remove();
    resetUI();
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
  .then(stream => video.srcObject = stream)
  .catch(err => {
    console.error("âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:", err);
    alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
    });
  };

  document.body.appendChild(btn);
}

function resetUI() {
  bubble.style.display = 'none';
  document.querySelectorAll('.text-option').forEach(el => el.classList.remove('selected'));

  bubble.classList.remove(...neonClasses);
  currentNeonIndex = 0;
  bubble.classList.add(neonClasses[0]);

  quoteEn.textContent = '';
  quoteKo.textContent = '';

  document.getElementById('save').style.display = 'none';
  document.getElementById('share').style.display = 'none';
}

// ê³µìœ ìš© ì—…ë¡œë“œ
async function uploadCapturedImage(blob) {
  const formData = new FormData();
  formData.append('image', blob);
  const imgbbApiKey = 'YOUR_KEY_HERE';
  const imgbbEndpoint = `https://api.imgbb.com/1/upload?key=${imgbbApiKey}`;

  try {
    const response = await fetch(imgbbEndpoint, {
      method: 'POST',
      body: formData,
    });
    const result = await response.json();
    const imageUrl = result.data.url;
    await addToFirestore(imageUrl);
  } catch (error) {
    console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    alert('âš ï¸ Bubble Storage ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

async function addToFirestore(imageUrl) {
  const docRef = await firebase.firestore().collection('bubbles').add({
    imageUrl: imageUrl,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

    // ë“œë˜ê·¸ ê¸°ëŠ¥
    let isDragging = false, offsetX, offsetY;
    bubble.addEventListener('mousedown', startDrag);
    bubble.addEventListener('touchstart', startDrag, { passive: false });

    function startDrag(e) {
      isDragging = true;
      const rect = bubble.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
      document.addEventListener('touchmove', onDrag, { passive: false });
      document.addEventListener('touchend', stopDrag);
    }

    function onDrag(e) {
      if (!isDragging) return;
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const bubbleWidth = bubble.offsetWidth;
      const bubbleHeight = bubble.offsetHeight;
      const maxX = window.innerWidth - bubbleWidth;
      const maxY = window.innerHeight - bubbleHeight;
      let x = clientX - offsetX;
      let y = clientY - offsetY;
      x = Math.max(0, Math.min(x, maxX));
      y = Math.max(0, Math.min(y, maxY));
      bubble.style.left = `${x}px`;
      bubble.style.top = `${y}px`;
      bubble.style.transform = `translate(0, 0)`;
    }

    function stopDrag() {
      isDragging = false;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
      document.removeEventListener('touchmove', onDrag);
      document.removeEventListener('touchend', stopDrag);
    }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(' ');
      let line = '';
      for (let i = 0; i < words.length; i++) {
        const testLine = line + words[i] + ' ';
        const testWidth = ctx.measureText(testLine).width;
        if (testWidth > maxWidth && i > 0) {
          ctx.strokeText(line, x, y);
          ctx.fillText(line, x, y);
          line = words[i] + ' ';
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.strokeText(line, x, y);
      ctx.fillText(line, x, y);
    }

function showShareButton() {
  const old = document.getElementById('share');
  if (old) old.remove();

  const shareBtn = document.createElement('button');
  shareBtn.id = 'share';
  shareBtn.textContent = 'Share';
  shareBtn.style.position = 'absolute';
  shareBtn.style.bottom = '200px';
  shareBtn.style.left = '20px';
  shareBtn.style.zIndex = 10;
  shareBtn.style.background = 'white';
  shareBtn.style.border = 'none';
  shareBtn.style.borderRadius = '10px';
  shareBtn.style.padding = '6px 10px';
  shareBtn.style.fontSize = '14px';
  shareBtn.style.cursor = 'pointer';

  shareBtn.addEventListener('click', async () => {
    if (!lastCaptureBlob) return;

    const filesArray = [new File([lastCaptureBlob], 'art-quote.png', { type: 'image/png' })];
    const shareData = {
      title: 'Art Quote',
      text: 'Hereâ€™s an art quote I captured.',
      files: filesArray
    };

    try {
      if (navigator.canShare && navigator.canShare({ files: filesArray })) {
        await navigator.share(shareData);
        alert('ê³µìœ  ì™„ë£Œ!');
      } else {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì´ë¯¸ì§€ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error('ê³µìœ  ì‹¤íŒ¨:', err);
    }

    // ë²„íŠ¼ ì œê±° ë° UI ë¦¬ì…‹
    shareBtn.remove();
    resetUI();
  });

  document.body.appendChild(shareBtn);
}
    
    let lastCaptureBlob = null;

    document.getElementById('capture').addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      const width = video.videoWidth;
      const height = video.videoHeight;
      if (!width || !height) {
        alert("ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
        return;
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      const bubbleRect = bubble.getBoundingClientRect();
      const videoRect = video.getBoundingClientRect();
      const scaleX = width / videoRect.width;
      const scaleY = height / videoRect.height;
      const x = (bubbleRect.left - videoRect.left) * scaleX;
      const y = (bubbleRect.top - videoRect.top) * scaleY;
      const bubbleW = bubbleRect.width * scaleX;
      const bubbleH = bubbleRect.height * scaleY;

      ctx.font = `${18 * scaleY}px sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      const text = (currentLang === 'en') ? quoteEn.textContent : quoteKo.textContent;
      const neonColors = ["#00ff90", "#ffaa00", "#00ccff"];
      ctx.lineWidth = 4;
      ctx.strokeStyle = neonColors[currentNeonIndex];
      ctx.fillStyle = "white";

      wrapText(ctx, text, x + bubbleW / 2, y + bubbleH / 2 - 10, bubbleW - 20, 24 * scaleY);

canvas.toBlob(blob => {
  lastBlob = blob;
  document.getElementById('save').style.display = 'inline-block';
  document.getElementById('share').style.display = 'inline-block';

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'text-bubble-capture.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showShareCombinedButton();
  }, 'image/png');
});

document.getElementById('save').onclick = () => {
  if (!lastBlob) return;
  const url = URL.createObjectURL(lastBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'bubble.png';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('share').onclick = async () => {
  if (!lastBlob) return;
  const file = new File([lastBlob], 'bubble.png', { type: 'image/png' });
  try {
    await navigator.share({
      title: 'Bubble',
      text: 'Check this out',
      files: [file]
    });
  } catch (e) {
    alert('ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }

  async function uploadCapturedImage(blob) {
    const formData = new FormData();
    formData.append('image', blob);

    const imgbbApiKey = 'f9427d6d511849d1476fdc31971a3b93'; 
    const imgbbEndpoint = `https://api.imgbb.com/1/upload?key=${imgbbApiKey}`;

    try {
      const response = await fetch(imgbbEndpoint, {
        method: 'POST',
        body: formData,
      });
      const result = await response.json();
      const imageUrl = result.data.url;

      // Firestoreì— ì´ë¯¸ì§€ ë§í¬ ì €ì¥
      await addToFirestore(imageUrl);

    } catch (error) {
      console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
      alert('âš ï¸ Bubble Storage ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  async function addToFirestore(imageUrl) {
    const docRef = await firebase.firestore().collection('bubbles').add({
      imageUrl: imageUrl,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  </script>
</body>
</html>
